<!doctype html>
<html lang="en" ng-app="billingApp">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Billing Details — Alpha Web Storefront</title>

  <!-- Bootstrap 5 (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --primary:#0d6efd;
      --muted:#6c757d;
      --card-bg:#1f2937;
      --card-text:#fff;
    }
    body{background:#f7fafc;color:#0b1220;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:18px;}
    .billing-container{max-width:820px;margin:20px auto;}
    .card-preview{
      width:320px;height:190px;border-radius:12px;padding:18px;color:var(--card-text);
      background: linear-gradient(135deg,#3b82f6,#06b6d4);box-shadow:0 10px 30px rgba(2,6,23,.12);
      display:flex;flex-direction:column;justify-content:space-between;
    }
    .card-number{letter-spacing:2px;font-weight:600;font-size:1.05rem}
    .card-meta{display:flex;justify-content:space-between;align-items:center;font-size:0.9rem}
    .brand-badge{font-weight:700;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,.12)}
    .muted{color:var(--muted)}
    .field-error{color:#dc3545;font-size:.9rem;margin-top:.25rem}
    .small-muted{font-size:.9rem;color:#6b7280}
    .mask{font-family:monospace}
  </style>
</head>
<body ng-controller="BillingController as vm">

  <div class="billing-container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h4 mb-0">Billing Details</h1>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
          <li class="breadcrumb-item"><a href="#">Alpha Storefront</a></li>
          <li class="breadcrumb-item active" aria-current="page">Billing</li>
        </ol>
      </nav>
    </div>

    <div class="row g-4">
      <!-- Form -->
      <div class="col-lg-7">
        <div class="card p-3 shadow-sm">
          <form name="billingForm" novalidate ng-submit="submitBilling(billingForm)" autocomplete="off" aria-labelledby="billingHeading">

            <h2 id="billingHeading" class="h5 mb-3">Payment Information</h2>

            <!-- Full Name -->
            <div class="mb-3">
              <label class="form-label">Full name</label>
              <input type="text" name="fullname" class="form-control" ng-model="billing.fullname"
                     ng-trim="true" required aria-required="true" placeholder="Jane Doe">
              <div class="field-error" ng-show="billingForm.fullname.$touched && billingForm.fullname.$invalid">
                Name is required.
              </div>
            </div>

            <!-- Address -->
            <div class="mb-3">
              <label class="form-label">Billing address</label>
              <input type="text" name="address" class="form-control" ng-model="billing.address"
                     required placeholder="123 Main St, Anytown, ST 12345">
              <div class="field-error" ng-show="billingForm.address.$touched && billingForm.address.$invalid">
                Address is required.
              </div>
            </div>

            <!-- Card Number -->
            <div class="mb-3">
              <label class="form-label">Credit card number</label>
              <div class="input-group">
                <input type="text" name="cardNumber" id="cardNumber"
                       class="form-control" ng-model="billing.cardNumber"
                       ng-change="formatCard()" ng-trim="false"
                       ng-pattern="/^\\d{4}\\s\\d{4}\\s\\d{4}\\s\\d{4}$/" required
                       maxlength="19" placeholder="1234 5678 9012 3456" aria-describedby="cardHelp">
                <span class="input-group-text small-muted" id="cardBrand">{{ cardBrandLabel }}</span>
              </div>
              <div id="cardHelp" class="small-muted mt-1">We accept Visa, Mastercard, AmEx (format accepted).</div>
              <div class="field-error" ng-show="(billingForm.cardNumber.$touched || submitted) && billingForm.cardNumber.$invalid">
                Enter a valid 16-digit card number in the format <code>1234 5678 9012 3456</code>.
              </div>
            </div>

            <div class="row">
              <!-- Expiry -->
              <div class="col-md-6 mb-3">
                <label class="form-label">Expiration (MM/YY)</label>
                <input type="text" name="expiry" id="expiry"
                       class="form-control" ng-model="billing.expiry" ng-change="formatExpiry()"
                       ng-pattern="/^(0[1-9]|1[0-2])\\/\\d{2}$/" maxlength="5" placeholder="MM/YY" required>
                <div class="field-error" ng-show="(billingForm.expiry.$touched || submitted) && billingForm.expiry.$invalid">
                  Enter a valid expiry in MM/YY.
                </div>
                <div class="field-error" ng-show="expiryInvalid && (billingForm.expiry.$touched || submitted)">
                  Card appears expired.
                </div>
              </div>

              <!-- CVV -->
              <div class="col-md-6 mb-3">
                <label class="form-label">CVV</label>
                <input type="text" name="cvv" class="form-control" ng-model="billing.cvv"
                       ng-pattern="/^\\d{3}$/" maxlength="3" placeholder="123" required>
                <div class="field-error" ng-show="(billingForm.cvv.$touched || submitted) && billingForm.cvv.$invalid">
                  3-digit CVV required.
                </div>
              </div>
            </div>

            <!-- Buttons -->
            <div class="d-grid gap-2 mt-3">
              <button type="submit" class="btn btn-primary btn-lg" ng-disabled="loading">
                <span ng-if="!loading"><i class="bi bi-credit-card"></i> Submit Billing</span>
                <span ng-if="loading">
                  <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                  Processing...
                </span>
              </button>
              <button type="button" class="btn btn-outline-secondary" ng-click="resetForm(billingForm)" ng-disabled="loading">Reset Form</button>
            </div>
          </form>

          <!-- Alert messages -->
          <div class="mt-3" ng-show="alert.message">
            <div class="alert" ng-class="{'alert-success': alert.type==='success','alert-danger': alert.type==='error','alert-warning': alert.type==='warning'}" role="alert">
              {{ alert.message }}
            </div>
          </div>

        </div>
      </div>

      <!-- Preview & Summary -->
      <div class="col-lg-5">
        <div class="card p-3 shadow-sm mb-3">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h3 class="h6 mb-0">Card Preview</h3>
            <div class="small-muted">Live update</div>
          </div>
          <div class="card-preview">
            <div>
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="small-muted">Alpha Web</div>
                <div class="brand-badge">{{ cardBrandLabel }}</div>
              </div>
              <div class="card-number" aria-live="polite">{{ previewNumber }}</div>
            </div>
            <div class="card-meta">
              <div>
                <div class="small-muted">Cardholder</div>
                <div>{{ billing.fullname || 'FULL NAME' }}</div>
              </div>
              <div>
                <div class="small-muted">Expires</div>
                <div>{{ billing.expiry || 'MM/YY' }}</div>
              </div>
            </div>
          </div>

          <div class="mt-3 small-muted">
            <strong>Security:</strong> This demo masks the full card number in summaries and never stores card data on the client beyond the session.
          </div>
        </div>

        <!-- Billing Summary -->
        <div class="card p-3 shadow-sm">
          <h3 class="h6">Billing Summary</h3>
          <div ng-if="!submitted" class="small-muted mb-2">Fill the form and submit to see summary.</div>

          <div ng-if="submitted">
            <dl class="row mb-0">
              <dt class="col-5 small-muted">Full name</dt>
              <dd class="col-7">{{ billing.fullname }}</dd>

              <dt class="col-5 small-muted">Address</dt>
              <dd class="col-7">{{ billing.address }}</dd>

              <dt class="col-5 small-muted">Card</dt>
              <dd class="col-7 mask">{{ maskedCard }}</dd>

              <dt class="col-5 small-muted">Paid</dt>
              <dd class="col-7">$ {{ paymentAmount.toFixed(2) }}</dd>
            </dl>

            <div class="mt-3">
              <button class="btn btn-outline-primary w-100" ng-click="downloadReceipt()">Download Receipt (PDF)</button>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>

  <!-- AngularJS + small icon lib for button icon -->
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
  <!-- Bootstrap JS for spinner & any components -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    (function(){
      angular.module('billingApp', [])
        .controller('BillingController', ['$scope', '$timeout', '$window', function($scope, $timeout, $window){
          // Model
          $scope.billing = {
            fullname: '',
            address: '',
            cardNumber: '',
            expiry: '',
            cvv: ''
          };

          $scope.loading = false;
          $scope.alert = {};
          $scope.submitted = false;
          $scope.paymentAmount = 1012.50; // demo amount, replace with real logic
          $scope.maskedCard = '';
          $scope.cardBrandLabel = 'Unknown';
          $scope.previewNumber = '•••• •••• •••• ••••';
          $scope.expiryInvalid = false;

          // Helpers
          $scope.formatCard = function(){
            if(!$scope.billing.cardNumber) {
              $scope.previewNumber = '•••• •••• •••• ••••';
              $scope.cardBrandLabel = 'Unknown';
              return;
            }
            // remove non-digit
            var digits = $scope.billing.cardNumber.replace(/\D/g,'').slice(0,16);
            // insert spaces every 4
            var parts = digits.match(/.{1,4}/g);
            var formatted = parts ? parts.join(' ') : digits;
            $scope.billing.cardNumber = formatted;
            $scope.previewNumber = formatted.replace(/\d/g,'•') || '•••• •••• •••• ••••';

            // card brand detection
            $scope.cardBrandLabel = detectCardBrand(digits);
            // update masked
            $scope.maskedCard = maskCard(digits);
          };

          $scope.formatExpiry = function(){
            if(!$scope.billing.expiry) return;
            var v = $scope.billing.expiry.replace(/[^\d]/g,'').slice(0,4);
            if(v.length >= 3){
              v = v.slice(0,2) + '/' + v.slice(2);
            }
            $scope.billing.expiry = v;
            // check expiry validity
            $scope.expiryInvalid = isExpired(v);
          };

          function detectCardBrand(numStr){
            if(/^4/.test(numStr)) return 'Visa';
            if(/^5[1-5]/.test(numStr)) return 'MasterCard';
            if(/^3[47]/.test(numStr)) return 'American Express';
            if(/^6/.test(numStr)) return 'Discover';
            return 'Unknown';
          }

          function maskCard(digits){
            if(!digits) return '•••• •••• •••• ••••';
            var last4 = digits.slice(-4);
            return '**** **** **** ' + last4;
          }

          function isExpired(mmYY){
            if(!/^(0[1-9]|1[0-2])\/\d{2}$/.test(mmYY)) return false;
            var parts = mmYY.split('/');
            var mm = parseInt(parts[0],10);
            var yy = parseInt(parts[1],10);
            // two-digit year; assume 2000-2099
            var exp = new Date(2000 + yy, mm, 1);
            // set to last day of month
            exp.setDate(0); // day 0 of next month gives last day of previous
            var today = new Date();
            return exp < today;
          }

          // Submission
          $scope.submitBilling = function(form){
            $scope.submitted = true;
            $scope.alert = {};

            // force validation messages
            if(form.$invalid || $scope.expiryInvalid){
              $scope.alert = {type:'error', message: 'Please correct the errors in the form before submitting.'};
              return;
            }

            // Do not keep full card number in model beyond session; mask for summary.
            var fullCardDigits = ($scope.billing.cardNumber || '').replace(/\D/g,'');
            $scope.maskedCard = maskCard(fullCardDigits);
            $scope.cardBrandLabel = detectCardBrand(fullCardDigits);

            // simulate processing (in real app you'd call a backend/payment gateway)
            $scope.loading = true;
            $timeout(function(){
              $scope.loading = false;
              $scope.alert = { type: 'success', message: 'Payment processed successfully. A receipt is available below.' };
              // For demo, we mark submitted true and keep maskedCard; clear sensitive fields
              $scope.billing.cardNumber = '';
              $scope.billing.cvv = '';
              // Note: expiry we keep for display only
            }, 1400);
          };

          $scope.resetForm = function(form){
            $scope.billing = {fullname:'', address:'', cardNumber:'', expiry:'', cvv:''};
            $scope.submitted = false;
            $scope.alert = {};
            $scope.loading = false;
            $scope.maskedCard = '';
            $scope.cardBrandLabel = 'Unknown';
            $scope.previewNumber = '•••• •••• •••• ••••';
            if(form){
              form.$setPristine();
              form.$setUntouched();
            }
          };

          $scope.downloadReceipt = function(){
            // Creates a simple text receipt and opens in new tab.
            var lines = [
              'Alpha Web Storefront — Payment Receipt',
              '--------------------------------------',
              'Name: ' + ($scope.billing.fullname || '(not provided)'),
              'Address: ' + ($scope.billing.address || '(not provided)'),
              'Card: ' + ($scope.maskedCard || 'N/A'),
              'Amount: $' + ($scope.paymentAmount.toFixed(2)),
              'Date: ' + new Date().toLocaleString(),
              '',
              'Thank you for your payment.'
            ];
            var blob = new Blob([lines.join('\\n')], { type: 'text/plain' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'receipt.txt';
            document.body.appendChild(a);
            a.click();
            setTimeout(function(){ URL.revokeObjectURL(url); a.remove(); }, 1000);
          };

          // Initialize little watchers for first-run preview
          $scope.$watch('billing.cardNumber', function(){ $scope.formatCard(); });
          $scope.$watch('billing.expiry', function(){ /* update preview handled in formatExpiry */ });
          $scope.formatCard(); // init
        }]);
    })();
  </script>
</body>
</html>